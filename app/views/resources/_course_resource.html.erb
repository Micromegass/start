<%# require: resource %>
<div class="col-sm-6 col-md-8 text-left">
  <h1>
    <%= resource.title %>
    <% if current_user.is_admin? %>
      <%= link_to edit_course_resource_path(resource.course,resource), nil do %>
        <%= content_tag(
          :span,nil,class:"glyphicon glyphicon-pencil action action-edit"
          )%>
      <% end %>
    <% end %>
  </h1>

  <p><%= resource.description %></p>
  <% resource.sections.each_with_index do |section, i| %>
    <div class="list-group lessons" id="section_<%= section.id %>">
      <div href="#" class="list-group-item resource-section-title">
        <%= "Sección #{i} - #{section.title}" %>
      </div>
      <% if current_user.has_access_to?(resource) %>
        <% section.lessons.each_with_index do |lesson, j| %>
          <div class="lesson" id="lesson_<%=lesson.id %>" data-sortable="true" data-resource-id="<%= lesson.id %>">
            <% if current_user.is_admin? %>
              <div class="row">
                <div class="col-lg-10">
                  <%= link_to(course_resource_section_lesson_path(resource.course,resource,section,lesson), class: "list-group-item") do %>
                    <%=" Lección #{j} - #{lesson.name}" %>
                    <span class="pull-right lesson-status glyphicon glyphicon-ok <%= 'completed' if current_user.has_completed_lesson?(lesson)%> "></span>
                  <% end %>
                </div>
                <div class="col-lg-2 lesson-actions">
                  <%= link_to '<span class="glyphicon glyphicon-pencil action action-edit"></span>'.html_safe, edit_lesson_path(lesson) %>
                  <%= link_to '<span class="glyphicon glyphicon-remove action action-remove"></span>'.html_safe,lesson_path(lesson),  remote: true, data:{ confirm: "Are you sure you want to delete this?"}, method: :delete %>
                </div>
              </div>
            <% else %>
              <%= link_to(course_resource_section_lesson_path(resource.course,resource,section,lesson), class: "list-group-item") do %>
                <%=" Lección #{j} - #{lesson.name}" %>
                <span class="pull-right lesson-status glyphicon glyphicon-ok <%= 'completed' if current_user.has_completed_lesson?(lesson)%> "></span>
              <% end %>
            <% end %>
          </div>
        <% end %>

      <% else %>

        <% section.lessons.each_with_index do |lesson, j| %>
          <% if lesson.free_preview? %>
            <%= link_to(course_resource_section_lesson_path(resource.course,resource,section,lesson),
              class: "list-group-item") do %>
              <%="Lección #{j} - #{lesson.name}"%>
              <span class="label-free">¡Gratis!</span>
            <% end %>
          <% else %>
            <div class="list-group-item disabled">
              <%="Lección #{j} - #{lesson.name}"%>
              <span class="glyphicon glyphicon-lock pull-right"></span>
            </div>
          <% end %>
        <% end %>

      <% end %>
    </div>
  <% end %>
  </a>
</div>
<div class="col-sm-6 col-md-4">
  <% if current_user.has_access_to?(resource) %>
    <%= render "comments/embedded", commentable: resource, questions:["Déjanos saber tu opinion"] %>
  <% else %>
    <div class="price-box-container text-center">
      <%= render '/shared/banner' if current_user.free_account? %>
    </div>
  <% end %>
</div>

<% if current_user.is_admin? %>
  <script>
    (function() {
      var sortables = [];
      <% resource.sections.each do |section| %>
        sortables.push(new SortableView({el: "#section_<%= section.id %>", resource:"lessons"}))
      <% end %>
      $(document).on("page:before-change", function() {
        _.each(sortables, function(sortable) {
          sortable.remove();
        })
      });
    })()
  </script>
<% end %>
