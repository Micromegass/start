<script>

$('.challenges').find('.challenge').attr('draggable', true);
$('.resources').find('tr').attr('draggable', true);

  function handleDragStart(e) {
    this.style.opacity = '0.4';
    e.originalEvent.dataTransfer.setData('sourceId', $(this).attr('id'));
  }
  function handleDragOver(e) {
    e.preventDefault();
  }
  function handleDragEnter(e) {
    $(this).addClass('over');
  }
  function handleDragLeave(e) {
    $(this).removeClass('over');
  }

  //Only for challenges
  function handleDragEnd(e) {
    this.style.opacity = '1';
    $('div, tr').removeClass('over');
  }



  function handleDropChallenge(e) {
    e.stopPropagation();
    var sourceId = e.originalEvent.dataTransfer.getData('sourceId');
    var sourceEl = $('#' + sourceId);
    $(e.currentTarget).before(sourceEl);
    $('div.challenge').each(function(index, el) {
      $(el).data('index', index);
    });

    $.ajax({
      url: '/challenges/' + sourceId + '/update_position',
      type: 'PATCH',
      contentType: 'application/json',
      data: '{ "position": ' + sourceEl.data('index') + '}',
      dataType: 'script'
    });
  }

  function handleDropResource(e) {
    e.stopPropagation();
    var sourceId = e.originalEvent.dataTransfer.getData('sourceId');
    var sourceEl = $('#' + sourceId);
    $(e.currentTarget).before(sourceEl);
    $('tr').each(function(index, el) {
      $(el).data('index', index);
    });

    $.ajax({
      url: '/resources/' + sourceId + '/update_position',
      type: 'PATCH',
      contentType: 'application/json',
      data: '{ "position": ' + sourceEl.data('index') + '}',
      dataType: 'script'
    });
  }

  $('.challenges')
    .on('dragstart', '.challenge', handleDragStart)
    .on('dragenter', '.challenge', handleDragEnter)
    .on('dragover', '.challenge', handleDragOver)
    .on('dragleave', '.challenge', handleDragLeave)
    .on('drop', '.challenge', handleDropChallenge)
    .on('dragend', '.challenge', handleDragEnd);

  $('.resources tbody')
    .on('dragstart', 'tr', handleDragStart)
    .on('dragenter', 'tr', handleDragEnter)
    .on('dragover', 'tr', handleDragOver)
    .on('dragleave', 'tr', handleDragLeave)
    .on('drop', 'tr', handleDropResource)
    .on('dragend', 'tr', handleDragEnd);
</script>
